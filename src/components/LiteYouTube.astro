---
/**
 * LiteYouTube - Lazy-loading YouTube facade component
 * Renders a thumbnail placeholder; loads iframe only on click
 *
 * Performance:
 * - Defers ~800 KiB of YouTube iframe until interaction
 * - Preconnects to YouTube on hover for faster iframe load
 * - Uses youtube-nocookie.com for privacy
 */
interface Props {
  videoid: string;
  title: string;
}

const { videoid, title } = Astro.props;
---

<!-- This component only registers the custom element - renders nothing visible -->
{/^[a-zA-Z0-9_-]{11}$/.test(videoid ?? "") ? (
  <lite-youtube
    videoid={videoid}
    title={title}
    content-title={title}
    role="button"
    tabindex="0"></lite-youtube>
) : (
  <div class="lite-youtube-error" role="alert">
    <p>Invalid or missing YouTube video ID.</p>
  </div>
)}
<style is:global>
  lite-youtube {
    display: block;
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    background-color: var(--color-surface);
    border-radius: var(--ui-radius);
    overflow: hidden;
    cursor: pointer;
    background-position: center center;
    background-size: cover;
    margin: var(--space-y-lg) 0;
  }

  lite-youtube::before {
    content: attr(title);
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: var(--space-3) var(--space-4);
    background: linear-gradient(to bottom, oklch(0.15 0.05 45 / 0.7), transparent); /* token-exempt */
    color: var(--color-overlay-text);
    font-size: var(--font-size-sm);
    font-family: var(--font-sans);
    z-index: var(--z-base);
  }

  lite-youtube .lyt-playbtn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: var(--space-17);
    height: var(--space-12);
    background-color: oklch(0.55 0.18 25); /* token-exempt */
    border: none;
    border-radius: var(--radius-xl);
    cursor: pointer;
    z-index: var(--z-base);
    transition: filter var(--duration-normal) var(--ease-out);
  }

  lite-youtube .lyt-playbtn::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-35%, -50%);
    border-style: solid;
    border-width: 11px 0 11px 19px; /* token-exempt */
    border-color: transparent transparent transparent var(--color-overlay-text);
  }

  lite-youtube:hover .lyt-playbtn {
    filter: brightness(1.1);
  }

  lite-youtube.lyt-activated {
    cursor: unset;
  }

  lite-youtube.lyt-activated::before,
  lite-youtube.lyt-activated .lyt-playbtn {
    display: none;
  }

  lite-youtube iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  .lite-youtube-error {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    aspect-ratio: 16 / 9;
    background-color: var(--color-surface);
    border: var(--ui-border);
    border-radius: var(--ui-radius);
    margin: var(--space-y-lg) 0;
    color: var(--color-muted);
    font-family: var(--font-sans);
    font-size: var(--font-size-sm);
  }
</style>

<script>
  class LiteYouTube extends HTMLElement {
    private static preconnected = false;
    private videoId = "";
    private abortController: AbortController | null = null;

    connectedCallback(): void {
      this.init();
    }

    /** Full (re-)initialization â€” safe to call multiple times. */
    init(): void {
      // Clean up any previous listeners (handles View Transitions)
      this.abortController?.abort();
      this.abortController = new AbortController();
      const { signal } = this.abortController;

      this.videoId = this.getAttribute("videoid") ?? "";
      if (!this.videoId) return;

      // Already activated with an iframe, nothing to do
      if (this.classList.contains("lyt-activated")) return;

      // Set high-quality thumbnail
      this.style.backgroundImage = `url("https://i.ytimg.com/vi/${this.videoId}/hqdefault.jpg")`;

      // Add play button (remove stale one first to avoid duplicates)
      this.querySelector(".lyt-playbtn")?.remove();
      const btn = document.createElement("button");
      btn.className = "lyt-playbtn";
      btn.type = "button";
      btn.setAttribute(
        "aria-label",
        `Play: ${this.getAttribute("title") ?? "Video"}`,
      );
      this.appendChild(btn);

      // Warm connections on hover
      this.addEventListener("pointerover", LiteYouTube.warmConnections, {
        once: true,
        signal,
      });

      // Load on click
      this.addEventListener("click", this.activate, { signal });

      // Keyboard activation: Enter or Space
      this.addEventListener(
        "keydown",
        (e: KeyboardEvent) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            this.activate();
          }
        },
        { signal },
      );
    }

    disconnectedCallback(): void {
      this.abortController?.abort();
      this.abortController = null;
    }

    private static warmConnections(): void {
      if (LiteYouTube.preconnected) return;
      LiteYouTube.preconnected = true;

      const preconnect = (url: string): void => {
        const link = document.createElement("link");
        link.rel = "preconnect";
        link.href = url;
        document.head.appendChild(link);
      };

      preconnect("https://www.youtube-nocookie.com");
      preconnect("https://www.google.com");
    }

    private activate = (): void => {
      if (this.classList.contains("lyt-activated")) return;

      const iframe = document.createElement("iframe");
      iframe.title = this.getAttribute("title") ?? "YouTube Video";
      iframe.allow =
        "accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;
      iframe.src = `https://www.youtube-nocookie.com/embed/${this.videoId}?autoplay=1&rel=0`;
      iframe.loading = "lazy";

      this.classList.add("lyt-activated");
      this.removeAttribute("role");
      this.removeAttribute("tabindex");
      this.appendChild(iframe);
    };
  }

  // Register custom element if not already defined
  if (!customElements.get("lite-youtube")) {
    customElements.define("lite-youtube", LiteYouTube);
  }

  // Re-init after Astro View Transition page swaps.
  // connectedCallback may or may not fire reliably during DOM swaps,
  // so we unconditionally call init() which is idempotent.
  document.addEventListener("astro:page-load", () => {
    document
      .querySelectorAll<LiteYouTube>("lite-youtube")
      .forEach((el) => el.init());
  });
</script>
