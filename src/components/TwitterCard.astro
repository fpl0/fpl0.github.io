---
interface TweetPhoto {
  url: string;
  width: number;
  height: number;
}

interface TweetUser {
  name: string;
  screen_name: string;
  profile_image_url_https: string;
}

interface TweetVideo {
  poster: string;
}

interface TweetData {
  user: TweetUser;
  text: string;
  created_at: string;
  photos?: TweetPhoto[];
  video?: TweetVideo;
}

interface Props {
  id: string;
}

const { id } = Astro.props;

// Helper to format date like "September 5, 2024"
function formatDate(dateString: string) {
  const date = new Date(dateString);
  return new Intl.DateTimeFormat("en-US", {
    month: "long",
    day: "numeric",
    year: "numeric",
  }).format(date);
}

// Fetch tweet data using the public syndication API (undocumented but stableish)
async function fetchTweet(id: string): Promise<TweetData | null> {
  try {
    const response = await fetch(`https://cdn.syndication.twimg.com/tweet-result?id=${id}&token=x`);
    if (!response.ok) throw new Error("Failed to fetch tweet");
    return await response.json();
  } catch (e) {
    console.error(`Error fetching tweet ${id}:`, e);
    return null;
  }
}

const tweet = await fetchTweet(id);

// HTML-escape untrusted API text to prevent XSS before inserting as HTML
function escapeHtml(str: string): string {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Extract relevant data safely â€” guard once, narrow types in frontmatter
const hasTweet = !!(tweet?.user && tweet?.text);
const user = tweet?.user as TweetUser;
const text = tweet?.text as string;
const date = tweet?.created_at ? formatDate(tweet.created_at) : "";
const photos: TweetPhoto[] = tweet?.photos || [];
const videoPoster = tweet?.video?.poster;
---

{
  hasTweet ? (
    <article class="tweet-card">
      <div class="tweet-header">
        <a
          href={`https://twitter.com/${user.screen_name}`}
          class="tweet-author-link"
          target="_blank"
          rel="noopener noreferrer"
        >
          <img
            src={user.profile_image_url_https}
            alt={user.name}
            class="tweet-avatar"
          />
          <div class="tweet-author-info">
            <span class="tweet-name">{user.name}</span>
            <span class="tweet-handle">@{user.screen_name}</span>
          </div>
        </a>
        <a
          href={`https://twitter.com/${user.screen_name}/status/${id}`}
          class="tweet-icon-link"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="View on Twitter"
        >
          <svg viewBox="0 0 24 24" aria-hidden="true" class="tweet-logo">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
          </svg>
        </a>
      </div>

      <div class="tweet-content">
        <p set:html={escapeHtml(text).replace(/\n/g, "<br/>")} />
      </div>

      {photos.length > 0 && (
        <a
          href={`https://twitter.com/${user.screen_name}/status/${id}`}
          class="tweet-media-link"
          target="_blank"
          rel="noopener noreferrer"
        >
          <div class={`tweet-media grid-${Math.min(photos.length, 4)}`}>
            {photos.map((photo: TweetPhoto) => (
              <img src={photo.url} alt="Tweet media" />
            ))}
          </div>
        </a>
      )}

      {videoPoster && (
        <div class="tweet-media">
          <img src={videoPoster} alt="Video thumbnail" class="video-poster" />
          <div class="video-overlay">
            <button class="play-button" aria-label="Play video">&#9654;</button>
          </div>
        </div>
      )}

      <div class="tweet-footer">
        <a
          href={`https://twitter.com/${user.screen_name}/status/${id}`}
          class="tweet-date"
          target="_blank"
          rel="noopener noreferrer"
        >
          {date}
        </a>
      </div>
    </article>
  ) : (
    <blockquote class="tweet-fallback">
      <p>
        <a href={`https://twitter.com/i/status/${id}`}>View Tweet on Twitter</a>
      </p>
    </blockquote>
  )
}

<style>
  .tweet-card {
    border: var(--space-px) solid var(--color-border);
    border-radius: var(--radius-xl);
    background-color: var(--color-surface); /* Slightly distinct from main bg */
    padding: var(--space-6);
    margin: var(--space-10) 0;
    max-width: 100%;
    font-family: var(--font-sans);
  }

  /* Header */
  .tweet-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-4);
  }

  .tweet-author-link {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    text-decoration: none;
    color: inherit;
    border-bottom: none; /* Override prose default */
  }

  .tweet-author-link:hover {
    background: transparent;
  }

  .tweet-avatar {
    width: var(--space-12);
    height: var(--space-12);
    border-radius: var(--radius-round);
    object-fit: cover;
    border: var(--space-px) solid var(--color-border);
  }

  .tweet-author-info {
    display: flex;
    flex-direction: column;
    line-height: 1.2;
  }

  .tweet-name {
    font-weight: 700;
    color: var(--color-text);
    font-size: var(--font-size-base);
  }

  .tweet-handle {
    font-family: var(--font-mono-brand); /* Space Mono for metadata */
    font-size: var(--font-size-xs);
    color: var(--color-muted);
  }

  .tweet-logo {
    width: var(--space-6);
    height: var(--space-6);
    fill: var(--color-text);
    opacity: var(--opacity-muted);
    transition:
      opacity var(--duration-normal) var(--ease-out),
      fill var(--duration-normal) var(--ease-out);
  }

  .tweet-icon-link:hover .tweet-logo {
    opacity: 1;
    fill: var(--color-text); /* Keep it monochrome/elegant per design */
  }

  /* Content */
  .tweet-content {
    font-family: var(--font-serif); /* Merriweather for the content itself */
    font-size: var(--font-size-lead);
    line-height: var(--line-height-normal);
    color: var(--color-text);
    margin-bottom: var(--space-4);
    white-space: pre-wrap; /* Preserve whitespace */
  }

  .tweet-media-link {
    display: block;
    text-decoration: none;
    border-bottom: none;
  }

  .tweet-media-link:hover {
    background: transparent;
  }

  /* Media Grid */
  .tweet-media {
    position: relative;
    margin-top: var(--space-4);
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: var(--space-px) solid var(--color-border);
  }

  .tweet-media img {
    width: 100%;
    height: auto;
    display: block;
    cursor: pointer;
  }

  .grid-2,
  .grid-3,
  .grid-4 {
    display: grid;
    gap: var(--space-1);
  }

  .grid-2 {
    grid-template-columns: 1fr 1fr;
  }
  .grid-3 {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
  }
  .grid-3 img:first-child {
    grid-row: span 2;
    height: 100%;
    object-fit: cover;
  }
  .grid-4 {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
  }

  /* Video placeholder */
  .video-poster {
    width: 100%;
    display: block;
  }

  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-overlay);
  }

  .play-button {
    background: none;
    border: none;
    color: var(--color-overlay-text);
    font-size: var(--font-size-h1);
    cursor: pointer;
    padding: var(--space-2);
  }

  /* Footer */
  .tweet-footer {
    border-top: var(--space-px) solid var(--color-border);
    margin-top: var(--space-4);
    padding-top: var(--space-3);
  }

  .tweet-date {
    font-family: var(--font-mono-brand);
    font-size: var(--font-size-xs);
    color: var(--color-muted);
    text-decoration: none;
    border-bottom: none;
  }

  .tweet-date:hover {
    text-decoration: underline;
    color: var(--color-primary);
  }

  /* Fallback */
  .tweet-fallback {
    /* Inherits standard blockquote styles if fetch fails */
  }

</style>
