---
/**
 * ImageLightbox - Click to zoom images in posts
 * Automatically attaches to all images in .content
 *
 * Features:
 * - Smooth scale animation on open/close
 * - Keyboard accessible (Escape to close)
 * - AbortController for proper event cleanup
 */
---

<div id="lightbox" class="lightbox">
  <button class="lightbox-close" aria-label="Close lightbox">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M18 6L6 18M6 6l12 12"></path>
    </svg>
  </button>
  <img id="lightbox-img" class="lightbox-img" src="" alt="" />
</div>

<style>
  .lightbox {
    position: fixed;
    inset: 0;
    background: var(--color-overlay-heavy);
    backdrop-filter: blur(var(--space-2));
    z-index: var(--z-overlay);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-8);
    opacity: 0;
    visibility: hidden;
    transition:
      opacity var(--duration-slow) var(--ease-out),
      visibility var(--duration-slow) var(--ease-out);
    cursor: zoom-out;
  }

  .lightbox.is-open {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-img {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-xl);
    transform: scale(0.95);
    transition: transform var(--duration-slow) var(--ease-out);
  }

  .lightbox.is-open .lightbox-img {
    transform: scale(1);
  }

  .lightbox-close {
    position: absolute;
    top: var(--space-6);
    right: var(--space-6);
    width: var(--space-11);
    height: var(--space-11);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface);
    border: var(--space-px) solid var(--color-border);
    border-radius: var(--radius-round);
    color: var(--color-muted);
    cursor: pointer;
    transition:
      color var(--duration-normal) var(--ease-out),
      border-color var(--duration-normal) var(--ease-out);
  }

  .lightbox-close:hover {
    color: var(--color-primary);
    border-color: var(--color-primary);
  }

  .lightbox-close svg {
    width: var(--space-5);
    height: var(--space-5);
  }

  /* Make content images zoomable */
  :global(.content img) {
    cursor: zoom-in;
    transition: opacity var(--duration-normal) var(--ease-out);
  }

  :global(.content img:hover) {
    opacity: var(--opacity-hover);
  }
</style>

<script>
  import { onPageReady } from "../utils/lifecycle";

  let previousActiveElement: HTMLElement | null = null;

  onPageReady((signal) => {
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById(
      "lightbox-img",
    ) as HTMLImageElement | null;
    const closeBtn = lightbox?.querySelector(
      ".lightbox-close",
    ) as HTMLElement | null;

    if (!lightbox || !lightboxImg) return;

    const openLightbox = (src: string, alt: string): void => {
      previousActiveElement = document.activeElement as HTMLElement | null;
      lightboxImg.src = src;
      lightboxImg.alt = alt;
      lightbox.classList.add("is-open");
      document.body.style.overflow = "hidden";
      requestAnimationFrame(() => closeBtn?.focus());
    };

    const closeLightbox = (): void => {
      lightbox.classList.remove("is-open");
      document.body.style.overflow = "";
      previousActiveElement?.focus();
      previousActiveElement = null;
    };

    document
      .querySelectorAll<HTMLImageElement>(
        ".content img:not(.tweet-card img):not(.tweet-avatar)",
      )
      .forEach((img) => {
        img.addEventListener("click", () => openLightbox(img.src, img.alt), {
          signal,
        });
      });

    lightbox.addEventListener(
      "click",
      (e) => {
        if (e.target === lightbox) closeLightbox();
      },
      { signal },
    );

    closeBtn?.addEventListener("click", closeLightbox, { signal });

    document.addEventListener(
      "keydown",
      (e) => {
        if (!lightbox.classList.contains("is-open")) return;

        if (e.key === "Escape") {
          closeLightbox();
          return;
        }

        if (e.key === "Tab") {
          const focusable = Array.from(
            lightbox.querySelectorAll<HTMLElement>(
              'button, [href], [tabindex]:not([tabindex="-1"])',
            ),
          );
          if (focusable.length === 0) {
            e.preventDefault();
            return;
          }
          const first = focusable[0] as HTMLElement | undefined;
          const last = focusable[focusable.length - 1] as HTMLElement | undefined;
          if (first && last) {
            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          }
        }
      },
      { signal },
    );
  });
</script>
